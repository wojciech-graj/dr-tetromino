-- title:   TODO
-- author:  Wojciech Graj
-- desc:    TODO
-- site:    TODO
-- license: AGPL-3.0-or-later
-- version: 0.0
-- script:  lua

--[[
    TODO
    Copyright (C) 2023  Wojciech Graj

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
--]]

--- Conventions
-- VARIABLE delta: time since last frame (ms)
-- VARIABLE g_*: global variable
-- VARIABLE c_*: constant variable

----------------------------------------
-- Piece -------------------------------
----------------------------------------

Piece = {
   x = 0,
   y = 0,
   variant = 0,
   size = 0,
   rot_map_x = 0,
   rot_map_y = 0,
}
Piece.__index = Piece

function Piece.new(x, y, size, rot_map_x, rot_map_y)
   local self = setmetatable({}, Piece)
   self.x = x
   self.y = y
   self.size = size
   self.rot_map_x = rot_map_x
   self.rot_map_y = rot_map_y
   return self
end

function Piece.new_from_template(piece)
   local self = setmetatable({}, Piece)
   self.x = piece.x
   self.y = piece.y
   self.size = piece.size
   self.rot_map_x = 210
   self.rot_map_y = 119

   local math_random = math.random
   local color_map = {[0] = 0}
   for i = 1, 4 do
      color_map[i] = math_random(4) * 16
   end

   for y = 1, self.size do
      for x = 1, self.size * 4 do
         local tile = mget(piece.rot_map_x + x - 1, piece.rot_map_y + y - 1)
         mset(self.rot_map_x + x - 1, self.rot_map_y + y - 1, tile % 16 + color_map[tile // 16])
      end
   end

   return self
end

function Piece.new_random()
   return Piece.new_from_template(gc_pieces[math.random(#gc_pieces)])
end

function Piece:draw()
   local width = g_width
   local x_start = 120 - width * 4

   map(self.rot_map_x + self.variant * self.size, self.rot_map_y, self.size, self.size, x_start + self.x * 8, self.y * 8, 0)
end

function Piece:drop()
   self.y = self.y + 1

   if not self:validate() then
      self.y = self.y - 1
      return false
   end

   return true
end

function Piece:place()
   for y = 0, self.size - 1 do
      for x = 0, self.size - 1 do
         local tile = mget(self.rot_map_x + self.variant * self.size + x, self.rot_map_y + y)
         if tile ~= 0 then
            mset(self.x + x, self.y + y, tile)
         end
      end
   end
end

function Piece:validate()
   for y = 0, self.size - 1 do
      for x = 0, self.size - 1 do
         if mget(x + self.rot_map_x + self.variant * self.size, y + self.rot_map_y) ~= 0
            and (mget(self.x + x, self.y + y) ~= 0
               or self.x + x < 0
               or self.x + x >= 10
               or self.y + y >= 17
            ) then
            return false
         end
      end
   end

   return true
end

function Piece:rotate_cw()
   self.variant = (self.variant + 1) % 4
   if not self:validate() then
      self.variant = (self.variant + 3) % 4
   end
end

function Piece:rotate_ccw()
   self.variant = (self.variant + 3) % 4
   if not self:validate() then
      self.variant = (self.variant + 1) % 4
   end
end

function Piece:move_left()
   self.x = self.x - 1
   if not self:validate() then
      self.x = self.x + 1
   end
end

function Piece:move_right()
   self.x = self.x + 1
   if not self:validate() then
      self.x = self.x - 1
   end
end

gc_pieces = {
   Piece.new(3, -2, 4, 210, 0, 2),  -- I
   Piece.new(4, 0, 2, 210, 4, 1),  -- O
   Piece.new(4, -1, 3, 210, 6, 4),  -- J
   Piece.new(4, -1, 3, 210, 9, 4),  -- L
   Piece.new(4, -1, 3, 210, 12, 2),  -- S
   Piece.new(4, -1, 3, 210, 15, 4),  -- T
   Piece.new(4, -1, 3, 210, 18, 2),  -- Z
}

----------------------------------------
-- main --------------------------------
----------------------------------------

function g_init(width, height)
   g_width = width
   g_height = height

   for y = 0, height do
      for x = 0, width do
         mset(x, y, 0)
      end
   end
end

function g_draw_game()
   local width = g_width
   local height = g_height

   local x_start = 120 - width * 4

   map(0, 0, width, height, x_start, 0)
end

function BOOT()
   g_init(10, 17)

   g_piece = Piece.new_random()
   g_drop_timer = 0
   g_prev_time = 0
end

function TIC()
   local t = time()
   g_t = t
   local delta = t - g_prev_time
   g_prev_time = t

   g_drop_timer = g_drop_timer + delta

   if btnp(2) then
      g_piece:move_left()
   end
   if btnp(3) then
      g_piece:move_right()
   end
   if btnp(4) then
      g_piece:rotate_ccw()
   end
   if btnp(5) then
      g_piece:rotate_cw()
   end

   if g_drop_timer >= 500 then
      g_drop_timer = 0
      if not g_piece:drop() then
         g_piece:place()
         g_piece = Piece.new_random()
      end
   end

   cls()
   g_draw_game()
   g_piece:draw()
end

-- <TILES>
-- 016:0000000000222000024222002422222024222220222222200222220000222000
-- 017:0000000022222220242222202422222024222220222222200222220000222000
-- 018:0000000000222220024444202422222022222220222222200222222000222220
-- 019:0000000000222000024222002422222024222220242222202422222022222220
-- 020:0000000022222000244442002222222022222220222222202222220022222000
-- 021:0000000022222220244444202222222022222220222222200222222000222220
-- 022:0000000000222220024444202422222024222220242222202422222022222220
-- 023:0000000022222000244422002222222022222220222222202222222022222220
-- 024:0000000022222220244444202222222022222220222222202222220022222000
-- 025:0000000022000220242224202244422022222220222222202222222022000220
-- 026:0000000022222220242222200242220002422200024222002422222022222220
-- 027:0000000022222220242222200242222002422220024222202422222022222220
-- 028:0000000022000220242224202244422022222220222222202222222022222220
-- 029:0000000022222220222224202222420022224200222242002222242022222220
-- 030:0000000022222220222222202222222022222220224442202422242022000220
-- 031:0000000022222220222222202222222022222220222222202222222022222220
-- 032:0000000000999000024999009499999094999990999999900999990000999000
-- 033:0000000099999990949999909499999094999990999999900999990000999000
-- 034:0000000000999990024444909499999099999990999999900999999000999990
-- 035:0000000000999000024999009499999094999990949999909499999099999990
-- 036:0000000099999000944449009999999099999990999999909999990099999000
-- 037:0000000099999990944444909999999099999990999999900999999000999990
-- 038:0000000000999990024444909499999094999990949999909499999099999990
-- 039:0000000099999000944499009999999099999990999999909999999099999990
-- 040:0000000099999990944444909999999099999990999999909999990099999000
-- 041:0000000099000990942224909944499099999990999999909999999099000990
-- 042:0000000099999990949999900249990002499900024999009499999099999990
-- 043:0000000099999990949999900249999002499990024999909499999099999990
-- 044:0000000099000990942224909944499099999990999999909999999099999990
-- 045:0000000099999990999994909999420099994200999942009999949099999990
-- 046:0000000099999990999999909999999099999990994449909422249099000990
-- 047:0000000099999990999999909999999099999990999999909999999099999990
-- 048:0000000000eee000024eee00e4eeeee0e4eeeee0eeeeeee00eeeee0000eee000
-- 049:00000000eeeeeee0e4eeeee0e4eeeee0e4eeeee0eeeeeee00eeeee0000eee000
-- 050:0000000000eeeee0024444e0e4eeeee0eeeeeee0eeeeeee00eeeeee000eeeee0
-- 051:0000000000eee000024eee00e4eeeee0e4eeeee0e4eeeee0e4eeeee0eeeeeee0
-- 052:00000000eeeee000e4444e00eeeeeee0eeeeeee0eeeeeee0eeeeee00eeeee000
-- 053:00000000eeeeeee0e44444e0eeeeeee0eeeeeee0eeeeeee00eeeeee000eeeee0
-- 054:0000000000eeeee0024444e0e4eeeee0e4eeeee0e4eeeee0e4eeeee0eeeeeee0
-- 055:00000000eeeee000e444ee00eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0
-- 056:00000000eeeeeee0e44444e0eeeeeee0eeeeeee0eeeeeee0eeeeee00eeeee000
-- 057:00000000ee000ee0e42224e0ee444ee0eeeeeee0eeeeeee0eeeeeee0ee000ee0
-- 058:00000000eeeeeee0e4eeeee0024eee00024eee00024eee00e4eeeee0eeeeeee0
-- 059:00000000eeeeeee0e4eeeee0024eeee0024eeee0024eeee0e4eeeee0eeeeeee0
-- 060:00000000ee000ee0e42224e0ee444ee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0
-- 061:00000000eeeeeee0eeeee4e0eeee4200eeee4200eeee4200eeeee4e0eeeeeee0
-- 062:00000000eeeeeee0eeeeeee0eeeeeee0eeeeeee0ee444ee0e42224e0ee000ee0
-- 063:00000000eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0
-- 064:0000000000666000024666006466666064666660666666600666660000666000
-- 065:0000000066666660646666606466666064666660666666600666660000666000
-- 066:0000000000666660024444606466666066666660666666600666666000666660
-- 067:0000000000666000024666006466666064666660646666606466666066666660
-- 068:0000000066666000644446006666666066666660666666606666660066666000
-- 069:0000000066666660644444606666666066666660666666600666666000666660
-- 070:0000000000666660024444606466666064666660646666606466666066666660
-- 071:0000000066666000644466006666666066666660666666606666666066666660
-- 072:0000000066666660644444606666666066666660666666606666660066666000
-- 073:0000000066000660642224606644466066666660666666606666666066000660
-- 074:0000000066666660646666600246660002466600024666006466666066666660
-- 075:0000000066666660646666600246666002466660024666606466666066666660
-- 076:0000000066000660642224606644466066666660666666606666666066666660
-- 077:0000000066666660666664606666420066664200666642006666646066666660
-- 078:0000000066666660666666606666666066666660664446606422246066000660
-- 079:0000000066666660666666606666666066666660666666606666666066666660
-- </TILES>

-- <MAP>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000310000000000000034000000000000000000000000000000
-- 001:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a200000000000000a3000000000000000000000000000000
-- 002:0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002192c3440000a30024c3c2410000a2000000000000000000000000000000
-- 003:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000140000000000000011000000000000000000000000000000
-- 004:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000617263716473627400000000000000000000000000000000000000000000
-- 005:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000538454825281518300000000000000000000000000000000000000000000
-- 006:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003100340000006344000000000000000000000000000000000000
-- 007:00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021927300a20053924100a200000000000000000000000000000000000000
-- 008:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014248300000000001100000000000000000000000000000000000000
-- 009:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000217200000031003400000000000000000000000000000000000000
-- 010:00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000062934400a30024938200a300000000000000000000000000000000000000
-- 011:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000001400000000005241000000000000000000000000000000000000
-- 012:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003300000000003200000000000000000000000000000000000000
-- 013:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006142005471006443005174000000000000000000000000000000000000
-- 014:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000238400000012228100000013000000000000000000000000000000000000
-- 015:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003100003400003300000000000000000000000000000000000000
-- 016:00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021c24324d20023e24100b244000000000000000000000000000000000000
-- 017:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001400001300000000001100000000000000000000000000000000000000
-- 018:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000031000000000034000000000000000000000000000000000000
-- 019:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000217200006382247300006283000000000000000000000000000000000000
-- 020:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005344001400005241001100000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

